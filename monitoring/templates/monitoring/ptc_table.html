<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Monitoring PTC</title>
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <title>Monitoring PTC</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                height: 100vh;
                overflow: hidden;
                background-color: #f5f5f5;
            }

            #sidebar {
                width: 220px;
                background-color: #e9e9e9;
                color: #111;
                padding: 15px;
                box-sizing: border-box;
                transition: transform 0.3s ease;
                overflow-y: auto;
                position: fixed;
                top: 50px;
                left: 0;
                height: calc(100vh - 50px);
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            }

            #sidebar.hidden {
                transform: translateX(-220px);
            }

            #main {
                margin-left: 0;
                padding: 50px 10px 20px 0;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                width: 100%;
                transition: margin-left 0.3s ease, width 0.3s ease;
            }

            #main.shifted {
                margin-left: 220px;
                width: calc(100% - 220px);
            }

            #table-container {
                flex: 1;
                overflow-y: auto;
                overflow-x: auto;
                max-height: calc(100vh - 140px);
                position: relative;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
                background-color: white;
            }

            thead {
                background-color: #696969;
                color: white;
            }

            th, td {
                padding: 4px 2px;
                font-size: 15px;
                border: 1px solid #ccc;
                line-height: 1.0;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            th {
                font-weight: bold;
                font-size: 17px;
            }

            td a {
                display: inline-block;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            td[data-col="ptc"], th[data-col="ptc"] {
                width: 70px;
                max-width: 70px;
                font-size: 16px;
            }

            td[data-col="address"], th[data-col="address"] {
                width: 190px;
                max-width: 190px;
                text-align: left;
            }

            td[data-col="time"], th[data-col="time"] {
                width: 110px;
                max-width: 110px;
            }

            td[data-col="t1"], th[data-col="t1"],
            td[data-col="t2"], th[data-col="t2"],
            td[data-col="g1"], th[data-col="g1"],
            td[data-col="g2"], th[data-col="g2"],
            td[data-col="q"], th[data-col="q"],
            td[data-col="dg"], th[data-col="dg"],
            td[data-col="dg_pct"], th[data-col="dg_pct"],
            td[data-col="gacm"], th[data-col="gacm"],
            td[data-col="tacm"], th[data-col="tacm"],
            td[data-col="g_adaos"], th[data-col="g_adaos"] {
                width: 50px;
                max-width: 50px;
            }

            td[data-col="dg_pct"], th[data-col="dg_pct"] {
                width: 60px;
                max-width: 60px;
            }

            td[data-col="v220"], th[data-col="v220"],
            td[data-col="pump"], th[data-col="pump"] {
                width: 30px;
                max-width: 30px;
            }

            td[data-col="t31"], th[data-col="t31"],
            td[data-col="t32"], th[data-col="t32"],
            td[data-col="t41"], th[data-col="t41"],
            td[data-col="t42"], th[data-col="t42"],
            td[data-col="t43"], th[data-col="t43"],
            td[data-col="t44"], th[data-col="t44"] {
                width: 40px !important;
                max-width: 40px !important;
            }

            #ptc-table thead th {
                position: sticky;
                top: 0;
                background-color: #696969;
                z-index: 2;
            }

            tr:nth-child(even) {
                background-color: #F0F0F0;
            }

            .hidden-col {
                display: none;
            }

            a {
                color: #663399;
                text-decoration: none;
            }

            td[data-col="ptc"] a,
            td[data-col="address"] a {
                text-decoration: underline;
            }

            td[data-col="ptc"] a {
                font-size: 18px;
                font-weight: bold;
            }

            #toggle-button {
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 1000;
                background: linear-gradient(90deg, #0066cc, #0099ff);
                color: white;
                border: none;
                padding: 10px 16px;
                font-size: 15px;
                cursor: pointer;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
                transition: background 0.3s ease;
            }

            #toggle-button:hover {
                background: linear-gradient(90deg, #005bb5, #0088e0);
            }
        </style>


    </head>
    <body>

    <button id="toggle-button" onclick="toggleSidebar()">Filtru</button>
    <input type="text" id="search-input" placeholder="Caută PTC..."
           style="position:fixed; top:10px; right:20px; z-index:1000; padding:6px; width:220px; border-radius:4px; border:1px solid #ccc;">

    <div id="sidebar" class="hidden">
        <h3>Selectare</h3>
        <label><input type="checkbox" value="t1" checked> T1</label>
        <label><input type="checkbox" value="t2" checked> T2</label>
        <label><input type="checkbox" value="t31" checked> T31</label>
        <label><input type="checkbox" value="t32" checked> T32</label>
        <label><input type="checkbox" value="t41" checked> T41</label>
        <label><input type="checkbox" value="t42" checked> T42</label>
        <label><input type="checkbox" value="t43" checked> T43</label>
        <label><input type="checkbox" value="t44" checked> T44</label>
        <label><input type="checkbox" value="g1" checked> G1</label>
        <label><input type="checkbox" value="g2" checked> G2</label>
        <label><input type="checkbox" value="q" checked> Q</label>
        <label><input type="checkbox" value="dg" checked> dG</label>
        <label><input type="checkbox" value="dg_pct" checked> Δ%</label>
        <label><input type="checkbox" value="gacm" checked> Gacm</label>
        <label><input type="checkbox" value="tacm" checked> Tacm</label>
        <label><input type="checkbox" value="g_adaos" checked> Gadaos</label>
        <label><input type="checkbox" value="v220" checked> 220V</label>
        <label><input type="checkbox" value="pump" checked> Pompa</label>
        <label><input type="checkbox" value="time" checked> Data/Ora</label>
    </div>

    <div id="main">
        <div id="table-container">
            <table id="ptc-table">
                <colgroup>
                    <col data-col="ptc" style="width: 70px">
                    <col data-col="address" style="width: 190px">
                    <col data-col="t1" style="width: 50px">
                    <col data-col="t2" style="width: 50px">
                    <col data-col="t31" style="width: 40px">
                    <col data-col="t32" style="width: 40px">
                    <col data-col="t41" style="width: 40px">
                    <col data-col="t42" style="width: 40px">
                    <col data-col="t43" style="width: 40px">
                    <col data-col="t44" style="width: 40px">
                    <col data-col="g1" style="width: 50px">
                    <col data-col="g2" style="width: 50px">
                    <col data-col="q" style="width: 50px">
                    <col data-col="dg" style="width: 50px">
                    <col data-col="dg_pct" style="width: 60px">
                    <col data-col="gacm" style="width: 50px">
                    <col data-col="tacm" style="width: 50px">
                    <col data-col="g_adaos" style="width: 50px">
                    <col data-col="v220" style="width: 30px">
                    <col data-col="pump" style="width: 30px">
                    <col data-col="time" style="width: 110px">
                </colgroup>
                <thead>
                <tr>
                    <th rowspan="2" data-col="ptc">PTC</th>
                    <th rowspan="2" data-col="address">Adresa</th>
                    <th rowspan="2" data-col="t1">T1</th>
                    <th rowspan="2" data-col="t2">T2</th>
                    <th colspan="2">T3</th>
                    <th colspan="4">T4</th>
                    <th rowspan="2" data-col="g1">G1</th>
                    <th rowspan="2" data-col="g2">G2</th>
                    <th rowspan="2" data-col="q">Q</th>
                    <th rowspan="2" data-col="dg">dG</th>
                    <th rowspan="2" data-col="dg_pct">Δ%</th>
                    <th rowspan="2" data-col="gacm">Gacm</th>
                    <th rowspan="2" data-col="tacm">Tacm</th>
                    <th rowspan="2" data-col="g_adaos">Gadaos</th>
                    <th rowspan="2" data-col="v220">220V</th>
                    <th rowspan="2" data-col="pump">Pompa</th>
                    <th rowspan="2" data-col="time">Data/Ora</th>
                </tr>
                <tr>
                    <th data-col="t31">T31</th>
                    <th data-col="t32">T32</th>
                    <th data-col="t41">T41</th>
                    <th data-col="t42">T42</th>
                    <th data-col="t43">T43</th>
                    <th data-col="t44">T44</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            sidebar.classList.toggle('hidden');
            main.classList.toggle('shifted');
        }

        function updateColumnVisibility() {
            const checkboxes = document.querySelectorAll('#sidebar input[type="checkbox"]');
            const visibleCols = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

            document.querySelectorAll('#ptc-table th, #ptc-table td').forEach(cell => {
                const col = cell.getAttribute('data-col');
                if (col && col !== 'ptc' && col !== 'address') {
                    cell.classList.add('hidden-col');
                }
            });

            visibleCols.forEach(col => {
                document.querySelectorAll(`[data-col="${col}"]`).forEach(cell => {
                    cell.classList.remove('hidden-col');
                });
            });
        }

        async function loadData() {
            const response = await fetch('/api/ptc/');
            const data = await response.json();

            const tbody = document.querySelector('#ptc-table tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');

                let cls = '';
                const t1 = parseFloat(row.t1);
                const dg_pct = parseFloat(row.dg_pct);
                if (t1 > 95 || dg_pct > 10) {
                    cls = 'error';
                } else if (t1 < 65 || dg_pct < -10) {
                    cls = 'warn';
                } else {
                    cls = 'good';
                }
                tr.className = cls;

                tr.innerHTML = `
        <td data-col="ptc">
            <a href="http://10.1.1.174/view/view_page.php?title=${row.ptc}" target="_blank">
                ${row.ptc}
            </a>
        </td>
        <td data-col="address">
            <a href="http://10.1.1.248:2222/?obiect=${row.ptc}" target="_blank">
                ${row.address}
            </a>
        </td>
        <td data-col="t1">${row.id_t1 ? `<a href="${row.id_t1}" target="_blank">${row.t1}</a>` : row.t1}</td>
        <td data-col="t2">${row.id_t2 ? `<a href="${row.id_t2}" target="_blank">${row.t2}</a>` : row.t2}</td>
        <td data-col="t31">${row.t31 !== undefined && row.t31 !== null ? row.t31 : ''}</td>
        <td data-col="t32">${row.t32 !== undefined && row.t32 !== null ? row.t32 : ''}</td>
        <td data-col="t41">${row.t41 !== undefined && row.t41 !== null ? row.t41 : ''}</td>
        <td data-col="t42">${row.t42 !== undefined && row.t42 !== null ? row.t42 : ''}</td>
        <td data-col="t43">${row.t43 !== undefined && row.t43 !== null ? row.t43 : ''}</td>
        <td data-col="t44">${row.t44 !== undefined && row.t44 !== null ? row.t44 : ''}</td>

        <td data-col="g1">${row.id_g1 ? `<a href="${row.id_g1}" target="_blank">${row.g1}</a>` : row.g1}</td>
        <td data-col="g2">${row.id_g2 ? `<a href="${row.id_g2}" target="_blank">${row.g2}</a>` : row.g2}</td>
        <td data-col="q">${row.id_q1 ? `<a href="${row.id_q1}" target="_blank">${row.q1}</a>` : row.q1}</td>
        <td data-col="dg">${row.id_dg ? `<a href="${row.id_dg}" target="_blank">${row.dg}</a>` : row.dg}</td>
        <td data-col="dg_pct">${row.dg_pct}</td>
        <td data-col="gacm">${row.id_gacm ? `<a href="${row.id_gacm}" target="_blank">${row.gacm}</a>` : row.gacm}</td>
        <td data-col="tacm">${row.id_tacm ? `<a href="${row.id_tacm}" target="_blank">${row.tacm}</a>` : row.tacm}</td>
        <td data-col="g_adaos">${row.id_g_adaos ? `<a href="${row.id_g_adaos}" target="_blank">${row.g_adaos}</a>` : row.g_adaos}</td>
        <td data-col="v220"><span style="color: ${row.v220 ? 'green' : 'red'};">●</span></td>
        <td data-col="pump"><span style="color: ${row.pump ? 'green' : 'red'};">●</span></td>
        <td data-col="time">${row.time}</td>
    `;
                tbody.appendChild(tr);
            });

            updateColumnVisibility();
        }

        document.querySelectorAll('#sidebar input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateColumnVisibility);
        });

        window.onload = () => {
            loadData();
            setInterval(loadData, 30000);
        };

        document.getElementById('search-input').addEventListener('input', function () {
            const term = this.value.toLowerCase();
            document.querySelectorAll('#ptc-table tbody tr').forEach(row => {
                const ptc = row.querySelector('[data-col="ptc"]').textContent.toLowerCase();
                row.style.display = ptc.includes(term) ? '' : 'none';
            });
        });
    </script>
    </body>
    </html>
